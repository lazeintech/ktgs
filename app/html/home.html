<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Trang chủ - Phần mềm kiểm tra giám sát</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <body id="i5qg" onload="onLoad()">
    <div id="i967">
      <div id="ieh4" class="container-width">
        <div class="logo-container"></div>
        <div class="clearfix"></div>
      </div>
      <div data-tabs="1" id="i1r88">
        <div data-gjs="navbar" class="navbar">
          <div class="navbar-container" id="i2em1r">
            <a href="/" class="navbar-brand"></a>
            <div id="bar-burger" class="navbar-burger">
              <div class="navbar-burger-line"></div>
              <div class="navbar-burger-line"></div>
              <div class="navbar-burger-line"></div>
            </div>
            <div data-gjs="navbar-items" class="navbar-items-c">
              <nav data-gjs="navbar-menu" class="navbar-menu">
                <a>Xin chào, <b id="user"></b></a>
                <script type="text/javascript">
                  document.getElementById("user").innerHTML = sessionStorage.getItem("username");
                </script>
                <a href="#" class="navbar-menu-link" id="home">Trang chủ</a>
                <a href="#" class="navbar-menu-link" id="setting-menu">Cài đặt</a>
              </nav>
            </div>
          </div>
        </div>
        <nav data-tab-container="1" class="tab-container" id="tab-container-id">
          <a href="#tab1" data-tab="1" value="1" class="tab" id="tabid1" onclick="loadTab()">
            TỔ CHỨC THI<br />(I)<br /></a>
          <a href="#tab2" data-tab="1" value="2" class="tab" id="tabid2" onclick="loadTab()">
            LÀM ĐỀ<br />(II)<br /></a>
          <a href="#tab3" data-tab="1" value="3" class="tab" id="tabid3" onclick="loadTab()">
            COI THI<br />(III)<br /></a>
          <a href="#tab4" data-tab="1" value="4" class="tab" id="tabid4" onclick="loadTab()">
            LÀM PHÁCH - GỬI BÀI<br />(IV)<br /></a>
          <a href="#tab5" data-tab="1" value="5" class="tab" id="tabid5" onclick="loadTab()">
            CHẤM THI<br />(V)<br /></a>
          <a href="#tab6" data-tab="1" value="6" class="tab" id="tabid6" onclick="loadTab()">
            THẨM ĐỊNH LUẬN VĂN, LUẬN ÁN<br />(VI)<br /></a>
        </nav>
      </div>
    </div>
    <form class="form" id="violation-form" onsubmit="addViolations(event)">
      <div class="form-group">
        <label class="label">Lớp phụ trách:</label>
        <select class="select" id="drop-classes" name="classCode" required> </select>
        <label class="label">Học phần:</label>
        <select class="select" id="drop-semesters" name="semesterCode" required> </select>
        <label class="label">Học viên:</label>
        <select class="select" id="drop-students" name="stdCode" required> </select>
        <label class="label">Ngày tháng:</label>
        <input type="date" id="date" name="date" required /><br /><br />
        <label class="label">Nội dung vi phạm:</label>
        <div id="i5aeml">
          <table id="tbl-violations" style="width:100%">
            <tbody>
              <tr>
                <td style="width:5%">STT</td>
                <td style="width:55%">Nội dung</td>
                <td style="width:30%">Tải lên</td>
                <td style="width:20%">Tải xuống</td>
              </tr>
            </tbody>
          </table><br />
          <button type="button" id="addViolationRecord">+</button>
          <button type="submit" class="button" id="saveViolationRecord">Lưu vi phạm</button>
        </div>
      </div>
    </form>
  </body>
  <script>
    var items = document.querySelectorAll('#i1r88');
    for (var i = 0, len = items.length; i < len; i++) {
      (function () {
        var t, e = this,
          a = "[data-tab]",
          n = document.body,
          r = n.matchesSelector || n.webkitMatchesSelector || n.mozMatchesSelector || n.msMatchesSelector,
          o = function () {
            var a = e.querySelectorAll("[data-tab-content]") || [];
            for (t = 0; t < a.length; t++) a[t].style.display = "none"
          },
          i = function (n) {
            var r = e.querySelectorAll(a) || [];
            for (t = 0; t < r.length; t++) {
              var i = r[t],
                s = i.className.replace("tab-active", "").trim();
              i.className = s
            }
            o(), n.className += " tab-active";
            var l = n.getAttribute("href"),
              c = e.querySelector(l);
            c && (c.style.display = "")
          },
          s = e.querySelector(".tab-active" + a);
        s = s || e.querySelector(a), s && i(s), e.addEventListener("click", function (t) {
          var e = t.target;
          r.call(e, a) && i(e)
        })
      }.bind(items[i]))();
    }
    var items = document.querySelectorAll('#bar-burger');
    for (var i = 0, len = items.length; i < len; i++) {
      (function () {
        var e, t = 0,
          n = function () {
            var e, t = document.createElement("void"),
              n = {
                transition: "transitionend",
                OTransition: "oTransitionEnd",
                MozTransition: "transitionend",
                WebkitTransition: "webkitTransitionEnd"
              };
            for (e in n)
              if (void 0 !== t.style[e]) return n[e]
          }(),
          r = function (e) {
            var t = window.getComputedStyle(e),
              n = t.display,
              r = (t.position, t.visibility, t.height, parseInt(t["max-height"]));
            if ("none" !== n && "0" !== r) return e.offsetHeight;
            e.style.height = "auto", e.style.display = "block", e.style.position = "absolute", e.style.visibility = "hidden";
            var i = e.offsetHeight;
            return e.style.height = "", e.style.display = "", e.style.position = "", e.style.visibility = "", i
          },
          i = function (e) {
            t = 1;
            var n = r(e),
              i = e.style;
            i.display = "block", i.transition = "max-height 0.25s ease-in-out", i.overflowY = "hidden", "" == i["max-height"] && (i["max-height"] = 0), 0 == parseInt(i["max-height"]) ? (i["max-height"] = "0", setTimeout(function () {
              i["max-height"] = n + "px"
            }, 10)) : i["max-height"] = "0"
          },
          a = function (r) {
            if (r.preventDefault(), !t) {
              var a = this.closest("[data-gjs=navbar]"),
                o = a.querySelector("[data-gjs=navbar-items]");
              i(o), e || (o.addEventListener(n, function () {
                t = 0;
                var e = o.style;
                0 == parseInt(e["max-height"]) && (e.display = "", e["max-height"] = "")
              }), e = 1)
            }
          };
        "gjs-collapse" in this || this.addEventListener("click", a), this["gjs-collapse"] = 1
      }.bind(items[i]))();
    }

    document.getElementById("setting-menu").addEventListener("click",
      function () {
        location.replace(location.origin + "/setting");
      },
      false
    );

    function onLoad() {
      loadTab();

      // goto tab
      var url_string = location.href;
      var url = new URL(url_string);
      var tab = url.searchParams.get("tab");
      if (tab)
        document.getElementById(tab).click();
    }

    function loadTab() {
      newViolationCount = 0;
      document.getElementById("drop-semesters").innerHTML = '';
      var table = document.getElementById("tbl-violations");
      for (var i = 1; i < table.rows.length;) {
        table.deleteRow(i);
      }
      // classes 
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var classes = JSON.parse(this.responseText);
          var select = document.getElementById("drop-classes");
          select.innerHTML = "<option value=\"\">- Chọn lớp -</option>";
          classes.forEach(cls => {
            var option = document.createElement("option");
            option.value = cls.classCode;
            option.text = cls.classCode;
            select.appendChild(option);
          });
        }
      };
      xmlhttp.open("POST", location.origin + "/api/get_classes", true);
      xmlhttp.send();
    }

    document.getElementById("drop-classes").addEventListener("change",
      function () {
        // semesters
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var semesters = JSON.parse(this.responseText);
            var select = document.getElementById("drop-semesters");
            select.innerHTML = "<option value=\"\">- Chọn học phần -</option>";
            semesters.forEach(sem => {
              var option = document.createElement("option");
              option.value = sem.semesterCode;
              option.text = sem.semesterCode;
              select.appendChild(option);
            });
          }
        };
        xmlhttp.open("POST", location.origin + "/api/get_semesters", true);
        xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xmlhttp.send(JSON.stringify({ "classCode": document.getElementById("drop-classes").value }));
      },
      false
    );

    document.getElementById("drop-semesters").addEventListener("change",
      function () {
        // violations
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var table = document.getElementById("tbl-violations");
            for (var i = 1; i < table.rows.length;) {
              table.deleteRow(i);
            }

            var vRecords = JSON.parse(this.responseText);
            vRecords.forEach(record => {
              var totalRowCount = table.rows.length;
              var row = table.insertRow(totalRowCount);
              var cell1 = row.insertCell(0);
              cell1.innerHTML = totalRowCount;
              var cell2 = row.insertCell(1);
              cell2.innerHTML = record.detail;
              var cell3 = row.insertCell(2);
              cell3.innerHTML = "";
              var cell4 = row.insertCell(3);
              cell4.innerHTML =
                ' <a href="/img/download.png" download>\
                    <img src="/img/download.png" width="24" height = "24" >\
                    </img> \
                  </a > ';
            });
          }
        };
        xmlhttp.open("POST", location.origin + "/api/get_violation_records", true);
        xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xmlhttp.send(JSON.stringify({
          "classCode": document.getElementById("drop-classes").value,
          "semesterCode": document.getElementById("drop-semesters").value,
          "job": document.getElementsByClassName('tab-active')[0].getAttribute('value')
        }));

        // students
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var students = JSON.parse(this.responseText);
            var select = document.getElementById("drop-students");
            select.innerHTML = '<option value="">- Chọn mã Học viên -</option>';
            students.forEach(student => {
              var option = document.createElement("option");
              option.value = student.stdCode;
              option.text = student.stdCode;
              select.appendChild(option);
            });
          }
        };
        xmlhttp.open("POST", location.origin + "/api/get_students", true);
        xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xmlhttp.send(JSON.stringify({
          "classCode": document.getElementById("drop-classes").value
        }));
      },
      false
    );

    let newViolationCount = 0;
    document.getElementById("addViolationRecord").addEventListener("click",
      function () {
        var table = document.getElementById("tbl-violations");
        var totalRowCount = table.rows.length;
        var row = table.insertRow(totalRowCount);
        var cell1 = row.insertCell(0);
        cell1.innerHTML = totalRowCount;
        var cell2 = row.insertCell(1);
        cell2.innerHTML = `<select class="select" id="drop-violation-${newViolationCount
          }" required> </select>`;
        var cell3 = row.insertCell(2);
        cell3.innerHTML = '<input type="file">';
        var cell4 = row.insertCell(3);
        cell4.innerHTML =
          ' <a href="/img/download.png" download>\
              <img src="/img/download.png" width="24" height = "24" >\
              </img> \
            </a > ';

        // load data into dropdown
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var violations = JSON.parse(this.responseText);
            select = document.getElementById("drop-violation-" + newViolationCount++);
            violations.forEach(violation => {
              var option = document.createElement("option");
              option.value = violation.detailId;
              option.text = violation.detail;
              select.appendChild(option);
            });
          };
        };
        xmlhttp.open("POST", location.origin + "/api/get_violation_detail", true);
        xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xmlhttp.send(JSON.stringify({
          "job": document.getElementsByClassName('tab-active')[0].getAttribute('value')
        }));
      },
      false
    );

    function addViolations(event) {
      // Prevent the form from submitting.
      event.preventDefault();

      const formData = new FormData(event.target);
      // Build the data object.
      formData.append('count', newViolationCount);
      var detailArr = [];
      for (i = 0; i < newViolationCount; ++i) {
        detailArr.push({
          'detailId': parseInt(document.getElementById("drop-violation-" + i).value)
        })
      }
      formData.append('detailArr', JSON.stringify(detailArr));
      formData.append('job', document.getElementsByClassName('tab-active')[0].getAttribute('value'));

      const data = {};
      formData.forEach((value, key) => (data[key] = value));
      // Log the data.
      console.log(data);

      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function () {
        console.log(this);
        if (this.readyState == 4) {
          if (this.status == 200) {
            alert("Thêm vi phạm thành công");
            loadTab();
          }
          else {
            alert("Có lỗi khi thêm vi phạm: " + this.responseText);
          }
        }
      };
      xmlhttp.open("POST", location.origin + "/api/add_violation_records", true);
      xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      xmlhttp.send(JSON.stringify(data));
    }
  </script>
</body>
<html>